<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Добавление сотрудника</title>

  <link rel="stylesheet" th:href="@{/css/fragments/sidebar.css}">
  <link rel="stylesheet" th:href="@{/css/employees/employee_add.css}">
</head>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('employeeForm');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();


      const formData = {
        surname: form.elements['surname']?.value || '',
        name: form.elements['name']?.value || '',
        patronymic: form.elements['patronymic']?.value || '',
        position: form.elements['position']?.value || '',
        paymentType: form.elements['paymentType']?.value || '',
        salary: form.elements['salary']?.value ? parseFloat(form.elements['salary'].value) : null,
        hireDate: form.elements['hireDate']?.value || ''
      };


      if (!formData.surname.trim() || !formData.name.trim() ||
              !formData.salary || !formData.hireDate) {
        showNotification('Заполните все обязательные поля', 'error');
        return;
      }

      const submitBtn = form.querySelector('.submit-btn');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Отправка';

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok && result.status === 'success') {
          showNotification('Сотрудник успешно добавлен!', 'success');
          form.reset();
        } else {
          const message = result.message || 'Не удалось добавить сотрудника';
          showNotification(message, 'error');
        }
      } catch (error) {
        console.error('AJAX error:', error);
        showNotification('Ошибка сети. Проверьте подключение.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  });

  function showNotification(message, type) {
    let notif = document.getElementById('form-notification');
    if (!notif) {
      notif = document.createElement('div');
      notif.id = 'form-notification';
      notif.className = 'notification';
      const form = document.getElementById('employeeForm');
      form.parentNode.insertBefore(notif, form);
    }

    notif.textContent = message;
    notif.className = `notification ${type}`;

    setTimeout(() => notif.classList.add('show'), 10);

    setTimeout(() => {
      notif.classList.remove('show');
      setTimeout(() => {
        if (notif.parentNode) {
          notif.parentNode.removeChild(notif);
        }
      }, 300);
    }, 5000);
  }
</script>

<body>
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<div id="notification" class="notification success" style="display: none;">
  <span id="notification-text"></span>
</div>

<div class="main-content">
  <h1>Регистрация сотрудника</h1>

  <form id="employeeForm" class="employee-form" th:action="@{/employees/add}" th:object="${employeeForm}" method="post">

    <div class="form-group">
      <label>Фамилия</label>
      <input type="text" th:field="*{surname}" required>
    </div>

    <div class="form-group">
      <label>Имя</label>
      <input type="text" th:field="*{name}" required>
    </div>

    <div class="form-group">
      <label>Отчество</label>
      <input type="text" th:field="*{patronymic}">
    </div>

    <div class="form-group">
      <label>Должность</label>
      <select th:field="*{position}">
        <option th:each="pos : ${positions}" th:value="${pos.positionName}" th:text="${pos.positionName}"></option>
      </select>
    </div>

    <div class="form-group">
      <label>Тип оплаты</label>
      <select th:field="*{paymentType}">
        <option value="FIXED">Фиксированная</option>
        <option value="HOURLY">Почасовая</option>
      </select>
    </div>

    <div class="form-group">
      <label>Ставка / Зарплата</label>
      <input type="number" th:field="*{salary}" step="0.01" required>
    </div>

    <div class="form-group">
      <label>Дата приёма</label>
      <input type="date" th:field="*{hireDate}" required>
    </div>

    <button type="submit" class="submit-btn">✅ Добавить сотрудника</button>

  </form>
</div>
</body>
</html>

